# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Архитектура проекта (MVC)

Для упрощения рефакторинга будет создан файл с константами для всего проекта. В нем также будут прописаны URL для доступа к API:

```typescript
export const API_URL = `${process.env.API_ORIGIN}/api/weblarek`;
export const CDN_URL = `${process.env.API_ORIGIN}/content/weblarek`;

export const SETTINGS: Settings = {
  // константы
}
```

В этом проекте будет использоваться архитектурный паттерн MVC. 

Единая модель данных будет реализована приложения в файле `src/components/model/AppState.ts`, содержащая всю логику работы с данными и возможные действия над ними. Все изменения данных происходят через методы модели, а она в свою очередь уведомляет об изменениях через метод настроек `onChange(changes: AppStateChanges)` чтобы не зависеть от конкретного способа коммуникации между компонентами. Подключение модели к системе событий производится через обертку `src/components/model/AppStateEmitter.ts`.

Экземпляр модели передается в контроллеры, которые по факту являются обработчиками пользовательских действий и обновляют состояние модели через ее методы. Экземпляры контроллеров передаются в качестве объекта содержащего обработчики событий в верхнеуровневые отображения (экраны).

При обработке событий возникающих в `AppStateEmitter` производится обновление данных в верхнеуровневых отображениях. Экраны это фактически крупные сборки инкапсулирующие детали реализации интерфейса и принимающие из вне только обработчики событий и необходимые данные. Экраны внутри составлены из более мелких отображений, которые инициализируют с помощью глобальных настроек проекта и распределяют данные между вложенными отображениями через свойства и метод `render()`.

Пример цепочки взаимодействия:

```typescript
const api = new Api(); // Инициализация API
const app = new ModelEmitter(api); // Инициализация модели и событий
const screen = new Screen( // Инициализация экрана
    // экран ждет объект с обработчиками событий, например { onClick: () => void }
	new Controller( // Инициализация контроллера
        /* { // Обработчики событий
            onClick: () => {
                app.model.value += 1;
            }
        }*/
		app.model // Передача модели в контроллер
    )
);

app.on('change:value', () => {
	screen.value = app.model.value;
});

// Screen.onClick -> Controller.onClick -> Model.value -> Screen.value
```

### Model (Модели)

Модели в проекте будут представлены классом `AppState`, который содержит в себе все данные и логику работы с ними. Модель частично реализует паттерн "Наблюдатель", и уведомляет об изменениях через метод `onChange(changes: AppStateChanges)`. Для удобства работы с данными в модели реализованы методы для изменения данных, которые в свою очередь вызывают метод `onChange()`.

#### Класс EventEmitter
Назначение: Базовый класс эмиттера (менеджера) событий

Методы:
`on(eventName: string, handler: EventHandler)` - метод добавления подписки на событие
`off(eventName: string, handler: EventHandler)` - метод удаления подписки на событие
`emit(eventName: string, data: object)` - метод эмита конкретного события
`reset()` - метод очистки событий
`bindEmitter(events: EventsMap)` - метод переопределения текущих событий

#### Класс `AppStateEmitter` extends EventEmitter
Назначение: класс обработки событий модели

Атрибуты:  
`model: AppState` - модель данных (стейт) приложения

Методы:  
`onModelChange(changed: AppStateChanges)` - обработчик событий изменения модели

#### enum AppStateModals
Назначение: содержит перечисление модальных окон в проекте

#### enum AppStateChanges
Назначение: содержит перечисление состояний приложения

#### Интефрейс AppState
Назначение: Интерфейс стейта приложения

Атрибуты:  
`products: Map<string, Product>;` - полученные с сервера продукты
`selectedProduct: Product | null;` - выбранный продукт
`openedModal: AppStateModals;` - открытая в данный момент модалка
`basket: Map<string, Product>` - добавленные в корзину продукты. Ключ id, значение Product
`paymentMethod: PaymentMethod` - значение способа оплаты
`address: string` - адрес в форме заказа
`credentials: Credentials` - значения email и телефона в форме заказа

#### Класс AppStateModel
Назначение: Класс стейта приложения

Атрибуты:  
`products: Map<string, Product>;` - полученные с сервера продукты
`selectedProduct: Product | null;` - выбранный продукт
`openedModal: AppStateModals;` - открытая в данный момент модалка

#### Интефрейс AppStateSettings
Назначение: настройка стейта

Атрибуты:  
`storageKey: string` - ключ стейта

Методы:  
`onChange: (changed: AppStateChanges) => void;` - функция, которая будет вызываться при изменении состояния 

#### Интефрейс AppStateConstructor
Назначение: конструктор стейта

Атрибуты:  
`api: IProductAPI` - используемое API
`settings: AppStateSettings` - настройки стейта

### View (Отображения)

Отображения в проекте разделены на три типа:
- `common` — общие компоненты, не зависящие от доменной области проекта
- `partial` — частичные компоненты, реализующие доменную область проекта
- `screen` — верхнеуровневые компоненты, которые являются экранами приложения

Первые два типа (common и partial) независимо типизированы, не используют глобальных настроек напрямую и могут быть легко переносимы между проектами. Экраны (screen) же зависят от глобальных настроек и используют их для инициализации и передачи данных между вложенными отображениями, так как по факту это соединительный код для удобства вынесенные в отдельные файлы и оформленный как отображение.

Если нужно использовать переданное отображение как шаблон, то можно использовать метод `copy()` — копирующие конструктор, который создает новый экземпляр отображения с теми же настройками (но их можно переопределить через параметры метода).

В общем случае при создании класса отображения мы передаем HTMLElement при помощи вызовов функций из `utils.ts` (`ensureElement`, `cloneTemplate`, `createElement`)
Пример:

```typescript
this.item = new CardView(cloneTemplate(SETTINGS.cardCatalog), {
	...SETTINGS.cardSettings,
	onClick: this.onOpenProductHandler.bind(this),
}),
```

Описания классов Отображений:

## `base`

#### Интерфейс IView<T, S = object>  
Назначение: Тип для отображения заданного типа данных

Атрибуты:  
`element`: HTMLElement; - корневой элемент

Методы:  
`copy(settings?: S): IView<T>;` - метод копирования компонента отображения
`render(data?: Partial<T>): HTMLElement;` - метод рендера компонента отображения

#### Класс View
Назначение: Базовый класс отображения

Атрибуты:  
`cache: Record<string, HTMLElement>` - кеш, чтобы не пересоздавать и не искать повторно элементы
`element`: HTMLElement; - корневой элемент

Методы:  
`init()` - метод жизненного цикла, вызываемый при инициализации компонента
`copy(settings?: S): IView<T>;` - метод копирования компонента отображения
`render(data?: Partial<T>): HTMLElement;` - метод рендера компонента отображения
`ensure<T extends HTMLElement>(query?: SelectorElement<T>,root: HTMLElement = this.element)` - метод проверки элемента с сохранением в кеш
`setElement<T extends HTMLElement>(query: SelectorElement<T>,value: HTMLElement): T` - метод замены одного элемента на другой/обновление элемента
`create<T extends HTMLElement>(settings: any, props?: ElementProps, children?: ElementChild): T` - метод создания отображения с переданными настройками, пропсами, дочерними элементами
`setVisibility<T extends HTMLElement>(query: SelectorElement<T>,isVisible: boolean)` - установка видимости
`setValue<T extends HTMLElement>(query: SelectorElement<T>,value: ElementValue<T>)` - установка свойств тега

#### Интерфейс IViewConstructor<T, S>  
Назначение: Тип конструктора отображения, который получает на вход клонированный шаблон или существующий элемент, а также настройки для отображения

Методы:  
new (root: HTMLElement, settings: S): IView<T>; - возвращает элемент отображения

#### Тип IClickableEvent<T>  
Назначение: тип для события клика

Атрибуты:  
`event`: MouseEvent - событие клика мышью
`item?`: T - данные элемента, по которому кликнули

#### Интерфейс IClickable<T>
Назначение: интерфейс для кликабельного элемента

Методы:  
`onClick: (args: IClickableEvent<T>) => void;` - метод клика

#### Тип IChangeableEvent<T> 
Назначение: тип для события изменения

Атрибуты:  
`event`: Event - событие изменения
`value?`: T - значение изменяемого элемента

#### Интерфейс IChangeable<T>
Назначение: интерфейс для изменяемого отображения

Методы:  
`onChange: (args:  IChangeableEvent<T>) => void;` - метод изменения

#### Тип ISelectableEvent<T> 
Назначение: тип для события выбора отображения

Атрибуты:  
`event`: Event - событие выбора
`value?`: T - значение выбираемого элемента

#### Интерфейс ISelectable<T>
Назначение: интерфейс для выбираемого отображения

Методы:  
`onChange: (args: ISelectableEvent<T>) => void;` - метод выбора


## `common`

#### Интерфейс `ButtonData`
Назначение: Данные для отображения компонента кнопки

Атрибуты:  
`label`: string - Текст, отображаемый внутри кнопки

#### Интерфейс `ButtonSettings`
Назначение: Настройки для отображения кнопки, в которых содержатся значения из константы `settings` (значения селекторов, переданные методы). В данном случае пустые, но при необходимости можно добавить значения.

#### Интерфейс `ListData<T>`
Назначение: Данные для отображения компонента списка элементов

Атрибуты:  
`items`: T[] - массив объектов данных для отображения элементов списка

#### Интерфейс `ListSettings<T>`
Назначение: Настройки для отображения компонента списка элементов, в которых содержатся значения из константы `settings` (значения селекторов).

Атрибуты:  
`item`: IView<T, unknown>; - значение отображение для рендеринга с данными типа T
`itemClass`: string; - значение селектора элемента списка карточки продукта

#### Интерфейс `ItemData`
Назначение: Тип для ограничения дженерика, т.к. мы должны быть уверены, что в данных для отображения элемента списка присутствует идентификатор

Атрибуты:  
`id`: string; - значение идентификатора карточки (продукта)

#### Интерфейс `ModalData`
Назначение: Тип для данных отображения модального окна

Атрибуты:  
`content`: string; - значение отображения для рендера в модальном окне
`isActive`: string; - значение видимости модального окна на странице

#### Интерфейс `ModalSettings`
Назначение: Настройки для отображения модального окна, в которых содержатся значения из константы `settings` (значения селекторов, переданные методы)

Атрибуты:  
`close: string;` - значение селектора кнопки закрытия диалога
`title: string;` - значение селектора заголовка модального окна
`content: string;` - значение селектора контейнера контента модального окна
`actions: string;` - значение селектора контейнера с действиями модального окна
`contentView: IView<C>;` - значение отображения для рендера
`activeClass: string;` - значение класса активности модального окна
	

Методы:  
`onOpen?: () => void;` - метод, вызывающийся при открытии модального окна
`onClose?: () => void;` - метод, вызывающийся при закрытии модального окна

## `partial`

#### Интерфейс `CardData`
Назначение: Тип для данных отображения карточки списка продуктов

Атрибуты:  
`id: string;` - идентификатор
`image: string;` - ссылка на изображение
`title: string;` - название

#### Интерфейс `CardSettings`
Назначение: Настройки для отображения карточки списка продуктов, в которых содержатся значения из константы `settings` (значения селекторов)

Атрибуты:  
`category: string,` - значение селектора категории
`title: string,` - значение селектора названия
`image: string,` - значение селектора изображения
`price: string,` - значение селектора цены


#### Интерфейс `PageData`
Назначение: Тип для данных отображения главной страницы (page)

Атрибуты:  
`counter: number;` - значение количества элементов в корзине
`isLocked: boolean;` - значение блокирования прокрутки экрана (при открытии модального окна)

#### Интерфейс `PageSettings`
Назначение: Настройки для отображения главной страницы, в которых содержатся значения из константы `settings` (значения селекторов)

Атрибуты:  
`wrapper: string;` - значение селектора обертки
`counter: string;` - значение селектора счетчкика продуктов в корзине
`basket: string;` - значение селектора корзины
`lockedClass: string;` - значение класса блокировки прокрутки экрана

#### Интерфейс `ProductData`
Назначение: Тип для данных отображения данных конкретного продукта

Атрибуты:  
`id: string;` - идентификатор
`description: string;` - описание
`image: string;` - ссылка на изображение
`title: string;` - название
`category: string;` - категория
`price: number;` - цена


#### Интерфейс `ProductViewSettings`
Назначение: Настройки для отображения конкретного продукта, в которых содержатся значения из константы `settings` (значения селекторов)

Атрибуты:  
`image: string;` - значение селектора ссылки на изображение
`title: string;` - значение селектора названия
`description: string;` - значение селектора описания
`category: string;` - значение селектора категории
`price: string;` - значение селектора цены

## `screen`

От интерфейсов `ModalScreenData` и `ModalScreenSettings` наследуются другие интерфейсы контента модальных окон, предствленных в screen

#### Интерфейс `ModalScreenData`
Назначение: Тип для данных отображения контента внутри модального окна

Атрибуты:  
`isDisabled: boolean;` - задизейблена ли кнопка submit
`isActive: boolean;` - отображается ли модальное окно


#### Интерфейс `ModalScreenSettings`
Назначение: Настройки для отображения контента модального окна

Методы:  
`onClose: () => void;` - метод, вызывающийся при открытии модального окна
`onSubmit: () => void;` - метод, вызывающийся при закрытии модального окна 



#### Интерфейс `BasketData`
Назначение: Тип для данных отображения модального окна корзины

Атрибуты:  
`products: ProductData[];` - продукты
`total: string;` - общая цена

#### Интерфейс `BasketSettings`
Назначение: Настройки для отображения контента модального окна корзины

Методы:  
`onRemove: (id: string) => void;` - метод, вызывающийся при удалении продукта из корзины

#### Интерфейс `CredentialsData`
Назначение: Тип для данных отображения модального окна данных пользователя

Атрибуты:  
`email: string;` - почта
`phone: string;` - телефон

#### Интерфейс `CredentialsSettings`
Назначение: Настройки для отображения контента модального окна данных пользователя

#### Интерфейс `MainData`
Назначение: Тип для данных отображения страницы со списком элементов

Атрибуты:  
`items: CardData[];` - данные для отображаемых элементов
`selected: Product;` - выбранный продукт

#### Интерфейс `MainSettings`
Назначение: Настройки для отображения страницы со списком элементов

Методы:  
`onOpenBasket: () => void;` - метод открытия корзины
`onOpenProduct: (id: string) => void;` - метод открытия продукта

#### Интерфейс `ProductViewData`
Назначение: Тип для данных отображения модального окна просмотра продукта

Атрибуты:  
`product: ProductData` - данные продукта

#### Интерфейс `ProductViewScreenSettings`
Назначение: Настройки для отображения контента модального окна просмотра продукта

#### Интерфейс `SuccessData`
Назначение: Тип для данных отображения модального окна успешной покупки

#### Интерфейс `SuccessScreenSettings`
Назначение: Настройки для отображения контента модального окна успешной покупки

### Controller (Контроллеры)

#### Класс `Controller<T>`
Назначение: Контроллеры в проекте будут представлены классами унаследованными от `Controller`, и являются обработчиками пользовательских действий и обновляют состояние модели через ее методы. Контроллеры принимают в себя экземпляр модели и обрабатывают события, вызывая методы модели для изменения данных.

Атрибуты:  
`model: T` - модель для работы с данными
`api?: IProductAPI` - API для получения данных с сервера в контроллере

### Работа с API

#### Класс `Api`
Назначение: Для работы с API будет создан базовый класс с общим функционалом, от которого будут наследоваться другие классы API

Атрибуты:  
`baseUrl: string;` - базовый адрес для запроса
`_options: RequestInit;` - опции

Методы:  
`_handleResponse<T>(response: Response): Promise<T> ` - метод обработки ответа
`_get<T>(uri: string, method = EnumApiMethods.GET)` - метод GET запроса
`_post<T>(uri: string,data: object,method = EnumApiMethods.POST)` - метод POST запроса

#### Интерфейс `IProductAPI`
Назначение: Интерфейс для предоставленного API работы с продуктами:

Методы:  
`getProducts: () => Promise<Product[]>;` - получить список продуктов
`getProduct: (id: string) => Promise<Product>;` - получить данные по конкретному продукту
`postOrder: (order: Order) => Promise<OrderResult>;` - запрос на выполнение заказа

#### Класс `ProductAPI` extends Api implements IProductAPI
Назначение: класс для работы с API продуктов

Методы:  
`getProduct(id: string): Promise<Product>` -  метод получения данных конкретного продукта
`getProducts(): Promise<Product[]>` - метод получения списка продуктов
`postOrder(order: Order): Promise<OrderResult>` - метод оформления заказа